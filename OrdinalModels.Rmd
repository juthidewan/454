---
title: "Ordinal models"
author: "Sam Ding"
date: "11/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(rstanarm)
library(rstan)
library(readr)
library(dplyr)
library(broom.mixed)
library(bayesrules)
```

```{r}
nyc_clean <- read_csv("clean_data/nyc_names_vichy_complied.csv")

nyc_clean2 <- nyc_clean %>%
  mutate(transportation_desert_4cat = factor(transportation_desert_4cat, levels=c("Poor", "Limited", "Satisfactory", "Excellent"))) %>%
  mutate(transportation_desert_4num = factor(as.numeric(transportation_desert_4cat))) %>%
   mutate(asian_perc = (asian_count / total_pop) * 100) %>%
   mutate(white_perc = (white_count / total_pop)* 100) %>%
   mutate(black_perc = (black_count / total_pop)* 100) %>%
   mutate(latinx_perc = (latinx_count / total_pop)* 100) %>%
   mutate(native_perc = (native_count / total_pop)* 100) %>%
   mutate(below_poverty_perc = (below_poverty_line_count / total_pop) * 100) %>%
   mutate(noncitizen_perc = (noncitizen_count / total_pop)* 100) %>%
   mutate(evictions_perc = (eviction_count / total_pop)* 100) %>%
   mutate(uninsured_perc = (uninsured_count / total_pop)* 100) %>%
  mutate(unemployment_perc = (unemployment_count / total_pop)* 100) %>%
  filter(nta_type == 0)


max(nyc_clean2$total_pop)
```

```{r}
model1 <- stan_polr(transportation_desert_4num ~ total_pop + mean_income + unemployment_perc + below_poverty_perc + evictions_perc + white_perc + asian_perc + black_perc + latinx_perc + school_count + store_count, data =nyc_clean2, prior=R2(0.5),iter=500, seed = 86437, refresh=0, prior_PD=FALSE)
saveRDS(model1, 'ordinal_model_1.rds')

model2 <- stan_polr(transportation_desert_4num ~ mean_income + below_poverty_perc + evictions_perc + school_count + store_count, data =nyc_clean2, prior=NULL,iter=500, seed = 86437, refresh=0, prior_PD=FALSE)

model3 <- stan_polr(transportation_desert_4num ~white_perc + asian_perc + latinx_perc + black_perc, data =nyc_clean2, prior=NULL,iter=500, seed = 86437, refresh=0, prior_PD=FALSE)
```

```{r}
summary(model1)

print(model1)

tidy(model1, effects = "fixed", conf.int = TRUE, conf.level = 0.8)
tidy(model2, effects = "fixed", conf.int = TRUE, conf.level = 0.8)
tidy(model3, effects = "fixed", conf.int = TRUE, conf.level = 0.8)
```

```{r}
ordinal_accuracy<-function(post_preds,mydata){
  post_preds<-as.data.frame(post_preds)
  results<-c()
  for (j in (1:length(post_preds))){
    results[j]<-as.numeric(tail(names(sort(table(post_preds[,j]))))[4])
    }
  results<-as.data.frame(results)
  compare<-cbind(results,mydata$transportation_desert_4num)
  compare<-compare %>%mutate(results=as.numeric(results))
  compare<-compare %>% mutate(`mydata$transportation_desert_4num`=as.numeric(`mydata$transportation_desert_4num`))
  compare<-compare %>%mutate(accuracy=ifelse(as.numeric(results)==as.numeric(`mydata$transportation_desert_4num`),1,0))
  print(sum(compare$accuracy)/length(post_preds))
}
```

```{r}
loo_m1 <- loo(model1)
plot(loo_m1)
```


```{r}
nyc_clean2[is.na(nyc_clean2)] = 0

set.seed(86437)
my_prediction1 <- posterior_predict(
  model1, 
  newdata = nyc_clean2)

my_prediction2 <- posterior_predict(
  model2, 
  newdata = nyc_clean2)

nyc_clean2 %>%
  ggplot(aes(x=mean_income)) + geom_density()



ordinal_accuracy(my_prediction2,nyc_clean2)

pred <- posterior_predict(
  model1, 
  newdata = data.frame( 
    total_pop = 50000,
    mean_income= 80000, 
    unemployment_perc=0.3, 
    evictions_perc = 2,
    below_poverty_perc = 2.1,
    white_perc = 4, 
    school_count= 12, 
    asian_perc = 1.2, 
    black_perc = 10,
    latinx_perc =  3.3, 
    store_count= 320))
  df <- as.data.frame(pred) %>%
    mutate(Classification  = case_when(
    `1` == 1 ~ 'Poor',
    `1` == 2 ~ 'Limited',
    `1` == 3 ~ 'Satisfactory',
    `1` == 4 ~ 'Excellent' )) %>%
  dplyr::select(Classification)
    
    tab <- table(df) %>% sort(decreasing=TRUE)
    names(dimnames(tab)) <- c("Classification")
    tab
    
    
    
```

```{r}
df_switched <- as.data.frame(my_prediction1)

# first remember the names
n <- df_switched$name

# transpose all but the first column (name)
df_switched <- as.data.frame(t(df_switched))
colnames(df_switched) <- n
for (i in 1:1000) {
  for (j in 1:180) {
    df_switched[i,j] <- as.numeric(df_switched[i,j])
  }
}

df_switched$mean <- mean(df_switched[1:1000])



```

