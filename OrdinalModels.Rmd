---
title: "Ordinal models"
author: "Sam Ding"
date: "11/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(rstanarm)
library(rstan)
library(readr)
library(dplyr)
library(broom.mixed)
library(bayesrules)
library(rsample)
```

```{r}
nyc_clean <- read_csv("clean_data/nyc_names_vichy_complied2.csv")

nyc_clean2 <- nyc_clean %>%
  mutate(transportation_desert_4cat = factor(transportation_desert_4cat, levels=c("Poor", "Limited", "Satisfactory", "Excellent"))) %>%
  mutate(transportation_desert_4num = factor(as.numeric(transportation_desert_4cat))) %>%
   mutate(asian_perc = (asian_count / total_pop) * 100) %>%
   mutate(white_perc = (white_count / total_pop)* 100) %>%
   mutate(black_perc = (black_count / total_pop)* 100) %>%
   mutate(latinx_perc = (latinx_count / total_pop)* 100) %>%
   mutate(native_perc = (native_count / total_pop)* 100) %>%
   mutate(below_poverty_perc = (below_poverty_line_count / total_pop) * 100) %>%
   mutate(noncitizen_perc = (noncitizen_count / total_pop)* 100) %>%
   mutate(uninsured_perc = (uninsured_count / total_pop)* 100) %>%
  mutate(unemployment_perc = (unemployment_count / total_pop)* 100) %>%
  filter(nta_type == 0)

```


```{r}
data_split <- initial_split(nyc_clean2, prop = .7) 
data_train <- training(data_split)
data_test <- testing(data_split) 
```

```{r}
model1 <- stan_polr(transportation_desert_4num ~   mean_income + unemployment_perc + below_poverty_perc + eviction_count + uninsured_perc +white_perc + asian_perc + black_perc + latinx_perc + school_count + store_count, data =data_train, prior=R2(0.5),iter=500, seed = 86437, refresh=0, prior_PD=FALSE)
saveRDS(model1, 'ordinal_model_1.rds')

model2 <- stan_polr(transportation_desert_4num ~ mean_income + below_poverty_perc + eviction_count + store_count, data =data_train, prior=R2(0.5),iter=500, seed = 86437, refresh=0, prior_PD=FALSE)
saveRDS(model2, 'ordinal_model_2.rds')

model3 <- stan_polr(transportation_desert_4num ~white_perc + asian_perc + latinx_perc + black_perc, data =nyc_clean2, prior=NULL,iter=500, seed = 86437, refresh=0, prior_PD=FALSE)
```

## PP check and Tidy
```{r}
# summary(model1)

pp_check(model1)
pp_check(model2)

tidy(model1, effects = "fixed", conf.int = TRUE, conf.level = 0.8)
tidy(model2, effects = "fixed", conf.int = TRUE, conf.level = 0.8)
# tidy(model3, effects = "fixed", conf.int = TRUE, conf.level = 0.8)
```

```{r}
ordinal_accuracy<-function(post_preds,mydata){
  post_preds<-as.data.frame(post_preds)
  results<-c()
  for (j in (1:length(post_preds))){
    results[j]<-as.numeric(tail(names(sort(table(post_preds[,j]))))[4])
    }
  results<-as.data.frame(results)
  compare<-cbind(results,mydata$transportation_desert_4num)
  compare<-compare %>%mutate(results=as.numeric(results))
  compare<-compare %>% mutate(`mydata$transportation_desert_4num`=as.numeric(`mydata$transportation_desert_4num`))
  compare<-compare %>%mutate(accuracy=ifelse(as.numeric(results)==as.numeric(`mydata$transportation_desert_4num`),1,0))
  print(sum(compare$accuracy)/length(post_preds))
}
```

## MCMC Diagnostic
```{r}
mcmc_trace(model2)
mcmc_dens_overlay(model2)
```


```{r}
nyc_clean2[is.na(nyc_clean2)] = 0

set.seed(86437)
my_prediction1 <- posterior_predict(
  model1, 
  newdata = data_test)

my_prediction2 <- posterior_predict(
  model2, 
  newdata = data_test)

nyc_clean2 %>%
  ggplot(aes(x=mean_income)) + geom_density()


set.seed(86437)
ordinal_accuracy(my_prediction1,data_test)
ordinal_accuracy(my_prediction2,data_test)

pred <- posterior_predict(
  model2, 
  newdata = data.frame( 
    # borough = "Manhattan",
    mean_income= 100000, 
    eviction_count = 20,
    below_poverty_perc = 2.1,
    # school_count= 12, 
    store_count= 50))
  df <- as.data.frame(pred) %>%
    mutate(Classification  = case_when(
    `1` == 1 ~ 'Poor',
    `1` == 2 ~ 'Limited',
    `1` == 3 ~ 'Satisfactory',
    `1` == 4 ~ 'Excellent' )) %>%
  dplyr::select(Classification)
    
    tab <- table(df) %>% sort(decreasing=TRUE)
    names(dimnames(tab)) <- c("Classification")
    tab
    
    
    
```

```{r}
df <- as.data.frame(my_prediction2)


# first remember the names
n <- df_switched$name

# transpose all but the first column (name)
df_switched <- as.data.frame(t(df_switched))
colnames(df_switched) <- n

aggregated_df <- data.frame("test", "test")
names(aggregated_df) <- c("highestPred", "actual")
aggregated_df <- aggregated_df[-1,]

names(sort(-table(df[1])))[1]


for (i in 1:55) {
  highestPred <- names(sort(-table(df[i])))[1]
  actual <- data_test$transportation_desert_4num[i]
  newdf <- data.frame(highestPred, actual)
  names(newdf) <- c("highestPred", "actual")
  aggregated_df <- rbind(aggregated_df, newdf)
}

aggregated_df$value = 1

ggplot(aggregated_df, aes(x=actual, y=value, fill=highestPred)) + geom_bar(position="fill", stat="identity") 




```

